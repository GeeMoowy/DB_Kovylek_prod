{% extends 'attendance/base.html' %}

{% block title %}Репетиция{% endblock %}

{% load static %}

{% block content %}
<div class="container mt-4">
    <!-- Сообщения об успешном сохранении -->
    {% if messages %}
    <div class="alert alert-success alert-dismissible fade show">
        {% for message in messages %}
        {{ message }}
        {% endfor %}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Заголовок с информацией о репетиции -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">
                <i class="bi bi-calendar-check"></i> Отметка посещаемости
            </h2>
        </div>
        <div class="card-body">
            <h4>
                Группа: {{ group }} |
                Дата: {{ repetition.date|date:"d.m.Y" }} |
                Время: {{ repetition.start_time|time:"H:i" }}
            </h4>
            <p class="mb-1">
                <strong>Участников:</strong> {{ students_count }} |
                <strong>Записей:</strong> {{ formset|length }}
            </p>
            {% if repetition.notes %}
            <p class="mb-0">
                <strong>Примечания:</strong> {{ repetition.notes }}
            </p>
            {% endif %}
        </div>
    </div>

    <!-- Основная форма -->
    <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        {{ formset.management_form }}

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40%">Участник</th>
                        <th class="text-center" style="width: 15%">Присутствовал</th>
                        <th style="width: 25%">Статус</th>
                        <th style="width: 20%">Комментарий</th>
                    </tr>
                </thead>
                <tbody>
                    {% for form in formset %}
                    <tr class="{% if form.present.value %}table-success{% endif %}">
                        <td>
                            {{ form.id }}
                            {{ form.student }}
                            <div class="d-flex align-items-center">
                                {% if form.instance.student.photo %}
                                <img src="{{ form.instance.student.photo.url }}"
                                     class="rounded-circle me-3"
                                     width="48"
                                     height="48"
                                     alt="{{ form.instance.student.full_name }}"
                                     onerror="this.src='{% static 'images/default-avatar.png' %}'">
                                {% else %}
                                <img src="{% static 'images/default-avatar.png' %}"
                                     class="rounded-circle me-3"
                                     width="48"
                                     height="48"
                                     alt="Default avatar">
                                {% endif %}
                                <div>
                                    <strong>{{ form.instance.student.full_name }}</strong>
                                    {% if form.instance.student.phone %}
                                    <div class="text-muted small">
                                        {{ form.instance.student.phone }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="text-center align-middle">
                            <div class="form-check d-flex justify-content-center">
                                {{ form.present }}
                            </div>
                        </td>
                        <td class="align-middle">
                            {{ form.status }}
                        </td>
                        <td class="align-middle">
                            {{ form.notes }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center py-4 text-danger">
                            <i class="bi bi-exclamation-triangle-fill"></i> Нет участников для отображения!
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <a href="{% url 'attendance:repetition_list' pk=group.id %}" class="btn btn-secondary me-md-2">
                <i class="bi bi-arrow-left"></i> Назад к списку
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Сохранить посещаемость
            </button>
        </div>
    </form>
</div>

<!-- Подключение Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">

<style>
    .form-check-input {
        transform: scale(1.5);
        cursor: pointer;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    select.form-select {
        min-width: 120px;
    }
</style>

<script>
// Автоматическое обновление статуса при изменении чекбокса
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.form-check-input');

    checkboxes.forEach(checkbox => {
        // Инициализация при загрузке
        const row = checkbox.closest('tr');
        const statusSelect = row.querySelector('select');

        // Обработчик изменения
        checkbox.addEventListener('change', function() {
            if(this.checked) {
                statusSelect.value = 'present';
                row.classList.add('table-success');
            } else {
                statusSelect.value = 'absent';
                row.classList.remove('table-success');
            }
        });

        // Инициализация текущего состояния
        if(checkbox.checked) {
            row.classList.add('table-success');
        }
    });
});
</script>
{% endblock %}