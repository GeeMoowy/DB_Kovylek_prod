{% extends 'attendance/base.html' %}
{% load static %}
{% block title %}Репетиция{% endblock %}
{% block content %}
<style>
    body {
        background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 50%, #80deea 100%);
        min-height: 100vh;
        background-attachment: fixed;
    }

    .container {
        padding-top: 1.5rem;
        padding-bottom: 2rem;
    }

    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }

    .card-header {
        background: linear-gradient(135deg, #00bcd4 0%, #008ba3 100%);
        color: white;
        padding: 1.25rem;
    }

    .table-responsive {
        background-color: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    .table {
        margin-bottom: 0;
    }

    .table th {
        background-color: #00bcd4;
        color: white;
        border-bottom: none;
        padding: 1rem;
        font-weight: 500;
    }

    .table td {
        padding: 1rem;
        vertical-align: middle;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0, 188, 212, 0.08) !important;
    }

    .table-success {
        background-color: rgba(0, 188, 212, 0.05);
    }

    .form-check-input {
        transform: scale(1.5);
        cursor: pointer;
        margin-top: 0;
    }

    .form-check-input:checked {
        background-color: #00bcd4;
        border-color: #00bcd4;
    }

    .form-select {
        border-radius: 6px;
        padding: 0.5rem;
        border: 1px solid #ced4da;
        transition: all 0.3s;
    }

    .form-select:focus {
        border-color: #00bcd4;
        box-shadow: 0 0 0 0.25rem rgba(0, 188, 212, 0.25);
    }

    .btn-primary {
        background-color: #00bcd4;
        border-color: #00bcd4;
    }

    .btn-primary:hover {
        background-color: #008ba3;
        border-color: #008ba3;
    }

    .alert-success {
        background-color: rgba(0, 188, 212, 0.15);
        border-color: rgba(0, 188, 212, 0.3);
        color: #006064;
    }

    .student-avatar {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #b2ebf2;
    }

    .empty-message {
        padding: 2rem;
        background-color: rgba(0, 188, 212, 0.05);
        color: #006064;
    }
</style>

<div class="container mt-3">
    <!-- Сообщения об успешном сохранении -->
    {% if messages %}
    <div class="alert alert-success alert-dismissible fade show mb-4">
        {% for message in messages %}
        <div class="d-flex align-items-center">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span>{{ message }}</span>
        </div>
        {% endfor %}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Заголовок с информацией о репетиции -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="mb-0">
                <i class="bi bi-calendar-check me-2"></i> Отметка посещаемости
            </h2>
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap align-items-center gap-4 mb-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-people-fill me-2 text-primary"></i>
                    <strong>Группа:</strong> {{ group }}
                </div>
                <div class="d-flex align-items-center">
                    <i class="bi bi-calendar-date me-2 text-primary"></i>
                    <strong>Дата:</strong> {{ repetition.date|date:"d.m.Y" }}
                </div>
                <div class="d-flex align-items-center">
                    <i class="bi bi-clock me-2 text-primary"></i>
                    <strong>Время:</strong> {{ repetition.start_time|time:"H:i" }}
                </div>
            </div>

            <div class="d-flex flex-wrap align-items-center gap-4">
                <div class="d-flex align-items-center">
                    <i class="bi bi-person-check me-2 text-primary"></i>
                    <strong>Участников:</strong> {{ students_count }}
                </div>
                <div class="d-flex align-items-center">
                    <i class="bi bi-list-check me-2 text-primary"></i>
                    <strong>Записей:</strong> {{ formset|length }}
                </div>
            </div>

            {% if repetition.notes %}
            <div class="mt-3 p-3 bg-light rounded">
                <i class="bi bi-chat-square-text me-2 text-primary"></i>
                <strong>Примечания:</strong> {{ repetition.notes }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Основная форма -->
    <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        {{ formset.management_form }}

        <div class="table-responsive mb-4">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="width: 40%">Участник</th>
                        <th class="text-center" style="width: 15%">Присутствовал</th>
                        <th style="width: 25%">Статус</th>
                        <th style="width: 20%">Комментарий</th>
                    </tr>
                </thead>
                <tbody>
                    {% for form in formset %}
                    <tr class="{% if form.present.value %}table-success{% endif %}">
                        <td>
                            {{ form.id }}
                            {{ form.student }}
                            <div class="d-flex align-items-center">
                                <img src="{% if form.instance.student.photo %}{{ form.instance.student.photo.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}"
                                     class="student-avatar me-3"
                                     onerror="this.src='{% static 'images/default-avatar.png' %}'">
                                <div>
                                    <strong>{{ form.instance.student.full_name }}</strong>
                                    {% if form.instance.student.phone %}
                                    <div class="text-muted small mt-1">
                                        <i class="bi bi-telephone me-1"></i>
                                        {{ form.instance.student.phone }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="form-check d-flex justify-content-center">
                                {{ form.present }}
                            </div>
                        </td>
                        <td>
                            {{ form.status }}
                        </td>
                        <td>
                            {{ form.notes }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="empty-message text-center">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            Нет участников для отображения!
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="{% url 'attendance:repetition_list' pk=group.id %}" class="btn btn-outline-secondary me-md-2">
                <i class="bi bi-arrow-left me-1"></i> Назад к списку
            </a>
            <button type="submit" class="btn btn-primary px-4">
                <i class="bi bi-save me-1"></i> Сохранить посещаемость
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Автоматическое обновление статуса
    const checkboxes = document.querySelectorAll('.form-check-input');

    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const statusSelect = row.querySelector('select');

        checkbox.addEventListener('change', function() {
            if(this.checked) {
                statusSelect.value = 'present';
                row.classList.add('table-success');
            } else {
                statusSelect.value = 'absent';
                row.classList.remove('table-success');
            }
        });

        // Инициализация текущего состояния
        if(checkbox.checked) {
            row.classList.add('table-success');
        }
    });

    // Анимация для формы
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateY(20px)';
        row.style.animation = `fadeInUp 0.4s ease forwards ${index * 0.05}s`;
    });

    // Добавляем стили для анимации
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}